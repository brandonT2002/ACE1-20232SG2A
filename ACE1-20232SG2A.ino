#include <LedControl.h>

int desfase = 0;
int cambioDesfase = 20;
int btnStart = 24;
int coordx;
int scrollDerecha = 0;
int mensajeContinuo = 0;
bool startPresionado = false;
int presionadoInicial = 0;
int seleccionDificultad = 1;
int estado = 1;

LedControl driver = LedControl(12, 10, 11, 1);
byte numeros[10][8][4] = {{{0, 0, 0, 0},
                           {0, 0, 1, 0},
                           {0, 1, 0, 1},
                           {0, 1, 0, 1},
                           {0, 1, 0, 1},
                           {0, 1, 0, 1},
                           {0, 0, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 0, 1, 0},
                           {0, 1, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 1, 1, 0},
                           {0, 0, 0, 1},
                           {0, 0, 1, 1},
                           {0, 1, 0, 0},
                           {0, 1, 0, 0},
                           {0, 1, 1, 1},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 1, 1, 0},
                           {0, 0, 0, 1},
                           {0, 1, 1, 0},
                           {0, 0, 0, 1},
                           {0, 0, 0, 1},
                           {0, 1, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 1, 0, 1},
                           {0, 1, 0, 1},
                           {0, 1, 1, 1},
                           {0, 0, 0, 1},
                           {0, 0, 0, 1},
                           {0, 0, 0, 1},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 1, 1, 0},
                           {0, 1, 0, 0},
                           {0, 1, 1, 0},
                           {0, 0, 0, 1},
                           {0, 0, 0, 1},
                           {0, 1, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 0, 1, 0},
                           {0, 1, 0, 0},
                           {0, 1, 1, 0},
                           {0, 1, 0, 1},
                           {0, 1, 0, 1},
                           {0, 0, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 1, 1, 1},
                           {0, 0, 0, 1},
                           {0, 0, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 0, 1, 0},
                           {0, 1, 0, 1},
                           {0, 0, 1, 0},
                           {0, 1, 0, 1},
                           {0, 1, 0, 1},
                           {0, 0, 1, 0},
                           {0, 0, 0, 0}},
                          {{0, 0, 0, 0},
                           {0, 0, 1, 0},
                           {0, 1, 0, 1},
                           {0, 0, 1, 1},
                           {0, 0, 0, 1},
                           {0, 0, 0, 1},
                           {0, 0, 1, 0},
                           {0, 0, 0, 0}}};

byte mensaje[24][8][6] = {
    {{0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 1, 0}, //<
     {0, 0, 0, 1, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 0, 0, 1, 0, 0},
     {0, 0, 0, 0, 1, 0},
     {0, 0, 0, 0, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0}, // P
     {0, 1, 0, 0, 1, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0}, // R
     {0, 1, 0, 0, 1, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // A
     {0, 1, 0, 0, 1, 0},
     {0, 1, 1, 1, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 0, 0}, // C
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 1, 1, 0, 0, 0},
     {0, 0, 1, 0, 0, 0}, // 1
     {0, 0, 1, 0, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 1, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0}, //-
     {0, 1, 1, 1, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 0, 0}, // G
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 1, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // R
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // U
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // P
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // O
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0}, // 2
     {0, 0, 0, 0, 1, 0},
     {0, 0, 0, 1, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 1, 1, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0}, //-
     {0, 1, 1, 1, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 0, 0}, // S
     {0, 0, 1, 1, 0, 0},
     {0, 0, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 1, 1, 1, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0}, // E
     {0, 1, 1, 1, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 1, 1, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 0, 0}, // C
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 0, 0}, // C
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 1, 1, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 0, 1, 0, 0, 0}, // I
     {0, 0, 1, 0, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 1, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // O
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 0, 1, 1, 0, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // N
     {0, 1, 1, 0, 1, 0},
     {0, 1, 0, 1, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 1, 1, 0, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}, // A
     {0, 1, 0, 0, 1, 0},
     {0, 1, 1, 1, 1, 0},
     {0, 1, 0, 0, 1, 0},
     {0, 1, 0, 0, 1, 0}},

    {{0, 0, 0, 0, 0, 0},
     {0, 0, 0, 0, 0, 0},
     {0, 0, 1, 0, 0, 0}, //>
     {0, 0, 0, 1, 0, 0},
     {0, 0, 0, 0, 1, 0},
     {0, 0, 0, 1, 0, 0},
     {0, 0, 1, 0, 0, 0},
     {0, 0, 0, 0, 0, 0}}};

void setup()
{

    randomSeed(millis());

    for (int i = 0; i < 8; i++)
    {
        pinMode(i, OUTPUT);
        digitalWrite(i, HIGH);
    }

    for (int i = 14; i < 22; i++)
    {
        pinMode(i, OUTPUT);
        digitalWrite(i, LOW);
    }

    for (int i = 22; i < 29; i++)
    {
        pinMode(i, INPUT);
    }

    scrollDerecha = digitalRead(22);
    mensajeContinuo = digitalRead(23);
    driver.shutdown(0, false);
    driver.setIntensity(0, 8);
}

void pintarled(int x, int y)
{
    if (x < 8)
    {
        digitalWrite(x + 14, HIGH);
        digitalWrite(y, LOW);
        delay(1);
        digitalWrite(x + 14, LOW);
        digitalWrite(y, HIGH);
    }
    else
    {
        driver.setLed(0, y, x - 8, true);
    }
}

void printNumero(int n)
{
    int centenas = int(n / 100);
    int decenas = int((n - centenas * 100) / 10);
    int unidades = int(n - centenas * 100 - decenas * 10);

    for (int x = 0; x < 4; x++)
    {
        for (int y = 0; y < 8; y++)
        {
            if (numeros[centenas][y][x])
            {
                pintarled(x + 1, y);
            }
        }
    }

    for (int x = 0; x < 4; x++)
    {
        for (int y = 0; y < 8; y++)
        {
            if (numeros[decenas][y][x])
            {
                pintarled(x + 6, y);
            }
        }
    }

    for (int x = 0; x < 4; x++)
    {
        for (int y = 0; y < 8; y++)
        {
            if (numeros[unidades][y][x])
            {
                pintarled(x + 11, y);
            }
        }
    }
}

void printMensajeContinuo()
{
    for (int letra = 0; letra < 23; letra++)
    {
        for (int x = 0; x < 6; x++)
        {
            coordx = desfase + x + 6 * letra;
            while (coordx < 0)
            {
                coordx += 138;
            }
            coordx = coordx % 138;
            if (coordx > 15)
            {
                continue;
            }
            for (int y = 0; y < 8; y++)
            {
                if (mensaje[letra][y][x])
                {
                    pintarled(coordx % 138, y);
                }
            }
        }
    }
}

void printMensajeLetra()
{
    if (desfase < 0)
    {
        desfase = 23;
    }

    for (int x = 0; x < 6; x++)
    {
        coordx = 5 + x;
        for (int y = 0; y < 8; y++)
        {
            if (mensaje[desfase % 23][y][x])
            {
                pintarled(coordx, y);
            }
        }
    }
}

void loop()
{

    if (digitalRead(btnStart))
    {
        if (!startPresionado)
        {
            startPresionado = true;
            presionadoInicial = millis();
        }
    }
    else
    {
        if (startPresionado)
        {
            startPresionado = false;
            int tiempoTotal = millis() - presionadoInicial;
            if (tiempoTotal > 3000)
            {
                if (estado == 1)
                {
                    estado = 2;
                    driver.clearDisplay(0);
                }
                else
                {
                    estado = 1;
                    driver.clearDisplay(0);
                }
            }
        }
    }

    switch (estado)
    {
    case 1:
        seleccionDificultad = 1;
        scrollDerecha = digitalRead(22);
        mensajeContinuo = digitalRead(23);

        if (mensajeContinuo)
        {
            printMensajeContinuo();
            cambioDesfase--;
            if (cambioDesfase == 0)
            {
                float n_desfase = 20 * (analogRead(A0) / 255);
                cambioDesfase = 3 + n_desfase;
                driver.clearDisplay(0);
                if (scrollDerecha)
                {
                    desfase++;
                }
                else
                {
                    desfase--;
                }
            }
        }
        else
        {
            printMensajeLetra();
            cambioDesfase--;
            if (cambioDesfase == 0)
            {
                float n_desfase = 60 * (analogRead(A0) / 255);
                cambioDesfase = 60 + n_desfase;
                driver.clearDisplay(0);
                if (scrollDerecha)
                {
                    desfase--;
                }
                else
                {
                    desfase++;
                }
            }
        }
        break;
    }
}
